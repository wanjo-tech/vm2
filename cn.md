# 使用 `node:vm` 构建一个安全的沙盒环境

**摘要**：JavaScript 的广泛应用在软件开发中引入了一个关键挑战：确保代码的安全执行。Node.js 中的 `node:vm` 模块提供了一种创建隔离执行环境的方法，尽管它带有安全限制。本文探讨扩展 `node:vm` 模块来开发一个新的、更安全的沙盒环境，旨在解决 `vm2` 库停更的问题。通过详细说明设计策略和核心实现，我们旨在为开发人员提供一个安全且灵活的解决方案，用于安全执行第三方或不受信任的代码。此外，论文还讨论了沙盒的应用领域和局限性，强调其在特定场景中的适用性和局限性。

**作者**：
- Wanjo Chan (@mgttt)，主要作者，负责沙盒设计和实现，wanjochan@gmail.com
- @XmiliaH，贡献了众多沙盒逃逸测试用例
- @j4k0xb，贡献了沙盒逃逸用例

在现代软件开发中，安全地执行第三方或不受信任的代码的重要性不言而喻。尽管 JavaScript 的动态和灵活性提高了开发效率，但它也带来了许多安全挑战。Node.js 的 `node:vm` 模块便于创建隔离的执行环境，提供有效的代码隔离。然而，历史上报告的安全漏洞引起了社区的广泛关注。尽管像 `vm2` 这样的库试图在 `node:vm` 之上构建更安全的沙盒，但基础性问题导致 `vm2` 最终停更 [1]。

本文旨在深入探讨扩展 `node:vm` 模块以打造一个新的、安全的沙盒环境，努力填补 `vm2` 库留下的空白。开发的代码可在 GitHub 上公开访问 [2]。

## Node.js `node:vm` 模块概述

`node:vm` 模块允许创建一个与主 Node.js 环境隔离的独立 JavaScript 执行环境，配备自定义的全局变量。这一能力允许开发人员安全地执行第三方代码，有效减轻对主环境的潜在恶意影响。

## 设计扩展沙盒环境的策略

`vm2` 库的停更增加了基于 `node:vm` 的新沙盒环境的需求。我们的目标是构建一个能够防范如下威胁的沙盒：

- 原型污染
- 全局变量泄露
- 异步操作劫持

### 核心实现策略

1. **阻止全局变量**：使用 `vm.createContext` 创建一个干净的执行上下文，删除或覆盖潜在危险的全局变量和函数，如 `eval` 和 `Function`。

2. **重写原型方法并保护 `Promise`**：为防止恶意代码逃逸出沙盒环境，我们不仅拦截并修改原型链上的关键方法，还实施措施保护 `Promise` 原型方法不被篡改。通过在沙盒初始化时维护这些方法的引用并严格检查它们的完整性，我们确保它们的未修改状态，保护沙盒中的异步编程。

3. **执行深度控制**：通过递归深度检测和控制机制，避免因无限递归引起的服务拒绝（DoS）攻击。

4. **异步操作管理和动态模块导入控制**：我们通过自定义 `importModuleDynamically` 处理函数实现对动态模块导入的严格控制，并管理异步操作。这种方法防止了未授权模块的加载，确保所有动态加载的代码在沙盒环境中安全执行。

### 详细代码实践

沙盒环境的核心扩展实现通过如下关键函数展示：

- `jevalx_raw`：基本执行函数，负责使用 `vm.createScript` 执行代码。
- `findEvilGetter`：一个关键函数，旨在识别原型链上的恶意 getter 函数，增强沙盒对原型污染攻击的安全性。
- `jevalx_ext`：扩展执行函数，负责创建和初始化沙盒环境，细致管理全局变量。
- `jevalx_core`：核心异步执行函数，通过捕获未处理的 Promise 拒绝和避免异步操作的安全漏洞，增强对异步操作的控制。

## 沙盒的应用和局限性

沙盒不是一个全功能的虚拟机，而是一个工具，用于在预定义的安全上下文中运行 JavaScript 代码，

提供代码隔离和执行控制，但没有传统虚拟机的完整功能，如完整的操作系统仿真或硬件虚拟化。

### 主要应用

1. **实现 JS 语法 API**：对于开发可扩展的 Web 应用程序和服务很有用，沙盒可以构建和测试实现 JavaScript 语法的 API。在安全环境中运行用户或第三方代码，确保主应用程序的安全性不受影响，如我们的 KK 项目 [3] 所应用。

2. **量化系统中的策略文件**：类似于流行的量化交易脚本语言 Pine Script [4]，沙盒使用户能够为量化交易系统编写自定义策略，确保安全性和隔离性，同时利用 JavaScript 的能力。

### 局限性

尽管沙盒为执行复杂的 JavaScript 代码提供了安全环境，但它不适合需要虚拟机完整功能的场景。专注于安全和轻量级，其性能和功能限制应被认识到。

## 安全考虑和未来展望

基于 `node:vm` 的沙盒的强代码隔离需要对 Node.js 更新和新发现的安全漏洞保持警惕。持续的安全审查和沙盒更新对于维护安全至关重要。

随着 ECMAScript 标准的发展和新功能的引入，预计未来的沙盒环境将能够适应更复杂的应用，并实现更精细的控制机制。

## 结论

在 `node:vm` 之上扩展一个新的沙盒环境，不仅有效地弥补了 `vm2` 库停更留下的空白，而且为执行第三方或不受信任代码提供了一个更安全、更灵活的解决方案。随着技术进步和安全实践的加深，我们对这种方法提供 Node.js 应用程序的强大安全保证感到乐观。

## 参考文献

[1] P. Simek, “关于停止更新 vm2 的通知,” 2020. [在线]. 可用: [https://github.com/patriksimek/vm2/issues/533].

[2] Wanjo Chan, “jevalx (JsSandbox)” n.d. [在线]. 可用: [https://github.com/wanjo-tech/vm2/blob/main/jevalx.js].

[3] Wanjo Chan, "KK 项目," n.d. [在线]. 可用: [https://github.com/wanjo-tech/kk].

[4] "Pine Script® 语言参考手册," TradingView, n.d. [在线]. 可用: [https://www.tradingview.com/pine-script-reference/v5/].
