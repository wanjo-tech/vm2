# 基于`node:vm`构建安全沙箱环境

在现代软件开发领域，安全地执行第三方或不可信代码显得尤为重要。尽管JavaScript的动态性和灵活性大大提高了开发效率，但这同时也带来了不少安全挑战。Node.js 的 `node:vm` 模块提供了一种独立执行环境的创建手段，它可以有效隔离运行代码，但历史上曾经出现的安全漏洞引起了社区的广泛关注。尽管有尝试如 `vm2` 库基于 `node:vm` 构建更安全的沙箱环境，但由于一些被认为是根本性问题，`vm2` 最终停止了更新 [1]。

本文旨在探讨如何在 `node:vm` 模块的基础上，扩展出一个新的、安全的沙箱环境，旨在填补 `vm2` 库留下的空白。代码已经在github公开 [2]。

## Node.js `node:vm` 模块概述

`node:vm` 模块允许创建一个独立的JavaScript执行环境，配备有自定义的全局变量，与主Node.js环境相隔离。这一特性使得开发者可以在其中安全地执行第三方代码，有效避免潜在的恶意操作对主环境造成的影响。

## 设计一个扩展沙箱环境的策略

随着 `vm2` 库的停更，基于 `node:vm` 扩展新的沙箱环境的需求日益增长。我们旨在构建一个能够抵御以下安全威胁的沙箱：

- 原型链污染
- 全局变量泄露
- 异步操作劫持

### 实现的核心策略

1. **封锁全局变量**：通过 `vm.createContext` 创建一个纯净的执行上下文，删除或覆盖诸如 `eval`、`Function` 等潜在危险的全局变量和函数。

2. **重写原型方法**：通过拦截和修改 `Promise` 等原型链上的关键方法，防止恶意代码通过这些方法逃逸沙箱环境。

3. **执行深度控制**：通过递归深度检测，避免因无限递归调用导致的服务拒绝攻击（DoS）。

4. **异步操作管理**：通过自定义 `importModuleDynamically` 处理函数，对模块的动态导入进行严格控制，防止加载未授权模块。

### 代码实践详解

以下几个关键函数体现了沙箱环境的核心扩展实现：

- `jevalx_raw`：作为基础执行函数，负责使用 `vm.createScript` 执行代码。
- `findEvilGetter`：用于在原型链上搜索恶意的 getter 函数。
- `jevalx_ext`：作为扩展执行函数，负责创建并初始化沙箱环境，进行全局变量的细致管理。
- `jevalx_core`：核心异步执行函数，增强了对异步操作的管控，通过捕获未处理的 Promise 拒绝，避免异步操作的安全漏洞。

## 安全考量与未来展望

尽管基于 `node:vm` 的沙箱环境能提供较强的代码隔离性，但对于Node.js环境的更新和新发现的安全漏洞，我们仍需保持高度警惕。持续的安全评审和沙箱环境的及时更新对保障其安全性至关重要。

随着 ECMAScript 标准的不断进化和新特性的引入，预计未来的沙箱环境将需要适应更加复杂的应用场景和实现更精细的控制机制。

## 结论

通过在 `node:vm` 的基础上扩展新的沙箱环境，我们不仅有效地填补了 `vm2` 库停更留下的空白，还为执行第三方或不可信代码提供了一种更加灵活和安全的解决方案。随着技术的不断进步和安全实践的不断深化，我们有理由相信，这种方法能够为Node.js应用的安全性提供坚实的保障。


[1] 关于vm2停止更新的通告：https://github.com/patriksimek/vm2/issues/533
[2] 我们的解决的源代码: https://github.com/wanjo-tech/vm2/blob/main/jevalx.js

## 参考文献

[1] P. Simek, “关于vm2停止更新的通告,” 2020. [Online]. Available: https://github.com/patriksimek/vm2/issues/533.

[2] Wanjo Chan, “我们的解决方案源代码,” n.d. [Online]. Available: https://github.com/wanjo-tech/vm2/blob/main/jevalx.js.

