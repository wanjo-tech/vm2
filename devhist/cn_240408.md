# 基于`node:vm`构建安全沙箱环境

**摘要**：随着JavaScript的广泛应用，确保代码执行的安全性成为了软件开发的一项重要挑战。Node.js的`node:vm`模块提供了一种创建独立执行环境的手段，但存在安全限制。本文探讨了如何在`node:vm`模块的基础上，扩展一个新的、更安全的沙箱环境，旨在填补已停止维护的`vm2`库的空白。通过详细介绍设计策略和核心实现，本文旨在为开发者提供一种既安全又灵活的解决方案，以安全地执行第三方或不可信代码。此外，本文还探讨了沙箱环境的应用领域与限制，强调其在特定场景下的适用性和局限性。

**作者**：
- Wanjo Chan (@mgttt)，主要作者，负责沙箱设计和实现，wanjochan@gmail.com
- @XmiliaH，提供大量的沙箱逃逸测试例子
- @j4k0xb，提供了部分沙箱逃逸例子


在现代软件开发领域，安全地执行第三方或不可信代码显得尤为重要。尽管JavaScript的动态性和灵活性大大提高了开发效率，但这同时也带来了不少安全挑战。Node.js 的 `node:vm` 模块提供了一种独立执行环境的创建手段，它可以有效隔离运行代码，但历史上曾经出现的安全漏洞引起了社区的广泛关注。尽管有尝试如 `vm2` 库基于 `node:vm` 构建更安全的沙箱环境，但由于一些被认为是根本性问题，`vm2` 最终停止了更新 [1]。

本文旨在探讨如何在 `node:vm` 模块的基础上，扩展出一个新的、安全的沙箱环境，旨在填补 `vm2` 库留下的空白。代码已经在github公开 [2]。

## Node.js `node:vm` 模块概述

`node:vm` 模块允许创建一个独立的JavaScript执行环境，配备有自定义的全局变量，与主Node.js环境相隔离。这一特性使得开发者可以在其中安全地执行第三方代码，有效避免潜在的恶意操作对主环境造成的影响。

## 设计一个扩展沙箱环境的策略

随着 `vm2` 库的停更，基于 `node:vm` 扩展新的沙箱环境的需求日益增长。我们旨在构建一个能够抵御以下安全威胁的沙箱：

- 原型链污染
- 全局变量泄露
- 异步操作劫持

### 实现的核心策略

1. **封锁全局变量**：通过 `vm.createContext` 创建一个纯净的执行上下文，删除或覆盖诸如 `eval`、`Function` 等潜在危险的全局变量和函数。

2. **重写原型方法**：通过拦截和修改 `Promise` 等原型链上的关键方法，防止恶意代码通过这些方法逃逸沙箱环境。

3. **执行深度控制**：通过递归深度检测，避免因无限递归调用导致的服务拒绝攻击（DoS）。

4. **异步操作管理**：通过自定义 `importModuleDynamically` 处理函数，对模块的动态导入进行严格控制，防止加载未授权模块。

### 代码实践详解

以下几个关键函数体现了沙箱环境的核心扩展实现：

- `jevalx_raw`：作为基础执行函数，负责使用 `vm.createScript` 执行代码。
- `findEvilGetter`：用于在原型链上搜索恶意的 getter 函数。
- `jevalx_ext`：作为扩展执行函数，负责创建并初始化沙箱环境，进行全局变量的细致管理。
- `jevalx_core`：核心异步执行函数，增强了对异步操作的管控，通过捕获未处理的 Promise 拒绝，避免异步操作的安全漏洞。

## 沙箱的应用领域与限制

本文所介绍的基于`node:vm`模块扩展的沙箱，并不旨在提供一个完整功能的虚拟机。相反，它主要设计为一个工具，使得JavaScript代码能够在一个预定义的安全上下文中运行。这样的设计意味着，虽然沙箱能够提供一定级别的代码隔离和执行控制，但它并不包含传统虚拟机所具备的所有特性，如完整的操作系统模拟或硬件虚拟化。

### 主要应用方向

1. **实现JS语法的API**：沙箱环境可以用于构建和测试实现JavaScript语法的API，这对于开发可扩展的Web应用程序和服务尤其有用。通过在安全的沙箱环境中运行用户或第三方代码，开发者可以保证主应用的安全性不受影响[3]。

2. **量化系统中的策略文件**：与市场上流行的量化交易脚本语言如Pine Script[4]类似，该沙箱环境也可以使用户能够为量化交易系统编写自定义策略。用户编写的策略文件在沙箱中执行，既能利用JavaScript的强大功能，又能确保执行环境的安全和隔离。

### 限制说明

虽然此沙箱提供了一个相对安全的环境，允许执行复杂的JavaScript代码，但它并不适合那些需要完整虚拟机特性的场景。沙箱的设计重点是安全性和轻量级，因此，在使用时需要考虑其性能和功能的局限。


## 安全考量与未来展望

尽管基于 `node:vm` 的沙箱环境能提供较强的代码隔离性，但对于Node.js环境的更新和新发现的安全漏洞，我们仍需保持高度警惕。持续的安全评审和沙箱环境的及时更新对保障其安全性至关重要。

随着 ECMAScript 标准的不断进化和新特性的引入，预计未来的沙箱环境将需要适应更加复杂的应用场景和实现更精细的控制机制。

## 结论

通过在 `node:vm` 的基础上扩展新的沙箱环境，我们不仅有效地填补了 `vm2` 库停更留下的空白，还为执行第三方或不可信代码提供了一种更加灵活和安全的解决方案。随着技术的不断进步和安全实践的不断深化，我们有理由相信，这种方法能够为Node.js应用的安全性提供坚实的保障。


## 参考文献

[1] P. Simek, “关于vm2停止更新的通告,” 2020. [Online]. Available: https://github.com/patriksimek/vm2/issues/533.

[2] Wanjo Chan, “jevalx (JsSandbox)” n.d. [Online]. Available: https://github.com/wanjo-tech/vm2/blob/main/jevalx.js.

[3] Wanjo Chan, "kk项目," n.d. [Online]. Available: [https://github.com/wanjo-tech/kk].

[4] "Pine Script 用户手册," TradingView, n.d. [Online]. Available: [https://cn.tradingview.com/pine-script-reference/v5/].


